<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lars Cloud-Konto (GeschÃ¼tzt)</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <style>
        body { 
            font-family: 'Segoe UI', sans-serif; display: flex; justify-content: center; align-items: center;
            min-height: 100vh; margin: 0; padding: 15px;
            background: #333 url('hintergrund.jpg') no-repeat center center fixed; background-size: cover;
        }
        body::before { content: ""; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: -1; }
        .card { background: rgba(255, 255, 255, 0.96); padding: 20px; border-radius: 20px; width: 100%; max-width: 450px; border-top: 6px solid #1a73e8; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        h2 { color: #1a73e8; margin: 0; text-align: center; }
        .user-name { font-size: 0.85em; color: #555; text-align: center; margin-bottom: 10px; border-bottom: 1px solid #ddd; padding-bottom: 5px; }
        .konto-display { background: #1a1a1a; color: #fff; padding: 15px; border-radius: 12px; text-align: center; margin-bottom: 20px; cursor: pointer; border: 1px solid #444; }
        .konto-wert { font-size: 1.8em; font-weight: bold; display: block; line-height: 1.2; }
        .status-switch { display: flex; gap: 5px; margin-bottom: 15px; }
        .status-btn { flex: 1; padding: 10px; border: none; border-radius: 20px; cursor: pointer; font-size: 0.85em; font-weight: bold; }
        .active { background: #1a73e8; color: white; }
        .inactive { background: #eee; color: #555; }
        .row { display: flex; gap: 10px; margin-bottom: 10px; }
        input { width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 8px; text-align: center; font-size: 16px; box-sizing: border-box; }
        .result { margin-top: 15px; padding: 15px; border-radius: 10px; background: #f0f7ff; border-left: 5px solid #1a73e8; min-height: 60px; }
        .btn-save { width: 100%; margin-top: 10px; padding: 14px; background: #27ae60; color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; }
        .footer { font-size: 0.7em; color: #888; text-align: center; margin-top: 15px; }
    </style>
</head>
<body>

<div class="card">
    <h2 id="titel">Lars Cloud-Konto</h2>
    <div class="user-name">Lars Kevin Piesker</div>

    <div class="konto-display" id="kontoBox" onclick="checkAuthAndRun(manuellesSaldo)">
        <small style="color: #888;">Cloud-Guthaben (GeschÃ¼tzt)</small>
        <span id="kontoAnzeige" class="konto-wert">--:--</span>
        <div id="kontoDetails" style="font-size: 0.75em; color: #aaa; margin-top: 8px;">Gesperrt ðŸ”’</div>
    </div>
    
    <div class="status-switch">
        <button id="btnAn" class="status-btn active" onclick="setStatus(468)">Angestellter</button>
        <button id="btnBe" class="status-btn inactive" onclick="setStatus(492)">Beamter</button>
    </div>

    <div class="row">
        <div style="flex:1"><label style="font-size:0.7em">Start 1</label><input type="time" id="s1" oninput="berechne()"></div>
        <div style="flex:1"><label style="font-size:0.7em">Ende 1</label><input type="time" id="e1" oninput="berechne()"></div>
    </div>
    <div class="row">
        <div style="flex:1"><label style="font-size:0.7em">Start 2</label><input type="time" id="s2" oninput="berechne()"></div>
        <div style="flex:1"><label style="font-size:0.7em">Ende 2</label><input type="time" id="e2" oninput="berechne()"></div>
    </div>

    <div id="ausgabe" class="result">Bitte anmelden...</div>
    
    <button class="btn-save" onclick="checkAuthAndRun(speichereInCloud)">Speichern & Synchronisieren</button>
    <button style="width:100%; margin-top:8px; padding:8px; background:#7f8c8d; color:white; border:none; border-radius:8px; font-size:0.8em;" onclick="logout()">Abmelden / Passwort Ã¤ndern</button>

    <div class="footer" id="statusSync">ðŸ”’ Zugriff gesperrt</div>
</div>

<script>
// --- KONFIGURATION ---
const MEIN_PASSWORT = "*Lokopo1803"; // <--- Ã„NDERE HIER DEIN PASSWORT!
const firebaseConfig = {
  apiKey: "AIzaSyDdwUBPREGlUiWR5HepxRZepzQ842WSzm0",
  authDomain: "zeitrechner-lars.firebaseapp.com",
  databaseURL: "https://zeitrechner-lars-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "zeitrechner-lars",
  storageBucket: "zeitrechner-lars.firebasestorage.app",
  messagingSenderId: "145270152186",
  appId: "1:145270152186:web:9073790de21d6493ade243"
};

// --- INITIALISIERUNG ---
firebase.initializeApp(firebaseConfig);
const database = firebase.database();
let sollMin = 468;
let aktuellerKontostand = 0;
let tagesSaldo = 0;
let isAuthenticated = false;

window.onload = function() {
    checkLogin();
};

function checkLogin() {
    const savedPw = localStorage.getItem('lars_pw');
    if (savedPw === MEIN_PASSWORT) {
        unlockApp();
    } else {
        const input = prompt("Bitte gib dein Passwort fÃ¼r den Cloud-Zugriff ein:");
        if (input === MEIN_PASSWORT) {
            localStorage.setItem('lars_pw', input);
            unlockApp();
        } else {
            alert("Falsches Passwort! Zugriff verweigert.");
            document.getElementById('ausgabe').innerHTML = "Zugriff gesperrt. Bitte Seite neu laden.";
        }
    }
}

function unlockApp() {
    isAuthenticated = true;
    document.getElementById('statusSync').innerHTML = "Cloud-Sync aktiv âœ…";
    const kontoRef = database.ref('users/lars/kontostand');
    kontoRef.on('value', (snapshot) => {
        aktuellerKontostand = snapshot.val() || 0;
        zeigeKonto(aktuellerKontostand);
    });
    berechne();
}

function logout() {
    localStorage.removeItem('lars_pw');
    location.reload();
}

function checkAuthAndRun(func) {
    if (isAuthenticated) { func(); } else { checkLogin(); }
}

// --- LOGIK ---
function zeigeKonto(stand) {
    let h = Math.floor(Math.abs(stand) / 60);
    let m = Math.abs(stand) % 60;
    let text = (stand >= 0 ? '+' : '-') + h + ":" + (m < 10 ? '0' : '') + m;
    document.getElementById('kontoAnzeige').innerText = text;
    document.getElementById('kontoAnzeige').className = 'konto-wert ' + (stand >= 0 ? 'plus' : 'minus');
    let tage = (Math.abs(stand) / sollMin).toFixed(2);
    document.getElementById('kontoDetails').innerHTML = `Guthaben: ${stand} Min. | ~ ${tage} Tage`;
}

function setStatus(min) {
    sollMin = min;
    document.getElementById('btnAn').className = (min === 468) ? 'status-btn active' : 'status-btn inactive';
    document.getElementById('btnBe').className = (min === 492) ? 'status-btn active' : 'status-btn inactive';
    berechne();
    if(isAuthenticated) zeigeKonto(aktuellerKontostand);
}

function tToM(v) { return v ? (parseInt(v.split(':')[0])*60 + parseInt(v.split(':')[1])) : null; }
function mToT(m) { m = (m + 1440) % 1440; return `${Math.floor(m / 60)}:${(m % 60) < 10 ? '0' : ''}${m % 60}`; }

function berechne() {
    const s1 = tToM(document.getElementById('s1').value);
    const e1 = tToM(document.getElementById('e1').value);
    const s2 = tToM(document.getElementById('s2').value);
    const e2 = tToM(document.getElementById('e2').value);
    const ausgabe = document.getElementById('ausgabe');
    if (s1 === null) { ausgabe.innerHTML = isAuthenticated ? "Warte auf Startzeit..." : "Bitte anmelden..."; return; }

    let infoText = "";
    if (!e1) {
        infoText = `<span class="target-box">Feierabend: ${mToT(s1 + sollMin + 30)} Uhr</span>`;
    } else if (e1 && s2 && !e2) {
        let restPause = (s2 - e1) >= 30 ? 0 : (30 - (s2 - e1));
        infoText = `<span class="target-box">Neues Ziel: ${mToT(s2 + (sollMin - (e1 - s1)) + restPause)} Uhr</span>`;
    }

    let netto = 0;
    if (e1 && !s2) {
        netto = (e1 - s1) > 390 ? (e1 - s1) - 30 : (e1 - s1);
    } else if (e1 && s2 && e2) {
        let d = (e1 - s1) + (e2 - s2);
        netto = d - (d > 390 ? Math.max(0, 30 - (s2 - e1)) : 0);
    }

    if (netto > 0 || (e1 && !s2)) {
        tagesSaldo = netto - sollMin;
        let h = Math.floor(Math.abs(tagesSaldo) / 60);
        let m = Math.abs(tagesSaldo) % 60;
        infoText += `<br>Tagessaldo: <span class="${tagesSaldo >= 0 ? 'plus' : 'minus'}">${tagesSaldo >= 0 ? '+' : '-'}${h}:${m<10?'0':''}${m}</span>`;
    }
    ausgabe.innerHTML = infoText;
}

function speichereInCloud() {
    if (!document.getElementById('e1').value && !document.getElementById('e2').value) return;
    database.ref('users/lars/kontostand').set(aktuellerKontostand + tagesSaldo).then(() => {
        alert("In Cloud gespeichert!");
        document.querySelectorAll('input').forEach(i => i.value = "");
        tagesSaldo = 0; berechne();
    });
}

function manuellesSaldo() {
    let eingabe = prompt("Saldo manuell anpassen (Minuten):", aktuellerKontostand);
    if (eingabe !== null && eingabe !== "") {
        database.ref('users/lars/kontostand').set(parseInt(eingabe));
    }
}
</script>
</body>
</html>

